From 3a3cc5cd37d9acaf33fc11b163d97e17e8109dc5 Mon Sep 17 00:00:00 2001
From: Alberto Murillo <alberto.murillo.silva@intel.com>
Date: Thu, 28 May 2015 11:21:45 -0500
Subject: [PATCH] Use oslo.config to search for config files

Make wsgi.Loader class use oslo_config CONF.find_file function rather than
utils.find_config

Remove utils.find_config function and its test cases to avoid code duplication

Modify unit tests to look for config files in etc/cinder since this is not a
default location for oslo_config to look for
---
 cinder/tests/integrated/integrated_helpers.py | 4 ++++
 cinder/tests/test_service.py                  | 3 +++
 cinder/wsgi.py                                | 5 ++++-
 3 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/cinder/tests/integrated/integrated_helpers.py b/cinder/tests/integrated/integrated_helpers.py
index 20d6fbf..2361765 100644
--- a/cinder/tests/integrated/integrated_helpers.py
+++ b/cinder/tests/integrated/integrated_helpers.py
@@ -17,12 +17,14 @@
 Provides common functionality for integrated unit tests
 """
 
+import os
 import random
 import string
 import uuid
 
 import fixtures
 import mock
+from oslo_config import cfg
 from oslo_log import log as logging
 
 from cinder import service
@@ -30,6 +32,8 @@ from cinder import test  # For the flags
 from cinder.tests.integrated.api import client
 
 
+CONF = cfg.CONF
+CONF.config_dir = os.path.abspath("etc/cinder")
 LOG = logging.getLogger(__name__)
 
 
diff --git a/cinder/tests/test_service.py b/cinder/tests/test_service.py
index c2de595..1e10408 100644
--- a/cinder/tests/test_service.py
+++ b/cinder/tests/test_service.py
@@ -20,6 +20,8 @@ Unit Tests for remote procedure calls using queue
 """
 
 
+import os
+
 import mock
 import mox
 from oslo_concurrency import processutils
@@ -48,6 +50,7 @@ test_service_opts = [
 
 CONF = cfg.CONF
 CONF.register_opts(test_service_opts)
+CONF.config_dir = os.path.abspath("etc/cinder/")
 
 
 class FakeManager(manager.Manager):
diff --git a/cinder/wsgi.py b/cinder/wsgi.py
index 1d1c4d0..38c604a 100644
--- a/cinder/wsgi.py
+++ b/cinder/wsgi.py
@@ -532,7 +532,10 @@ class Loader(object):
 
         """
         config_path = config_path or CONF.api_paste_config
-        self.config_path = utils.find_config(config_path)
+        self.config_path = CONF.find_file(config_path)
+
+        if not self.config_path:
+            raise exception.ConfigNotFound(path=config_path)
 
     def load_app(self, name):
         """Return the paste URLMap wrapped WSGI application.
-- 
2.1.0

